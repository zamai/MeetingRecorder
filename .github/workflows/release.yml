name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14  # macOS Sonoma with Apple Silicon

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release
        run: |
          xcodebuild -project MeetingRecorder.xcodeproj \
            -scheme MeetingRecorder \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package App
        run: |
          cd build/Build/Products/Release
          zip -r MeetingRecorder.zip MeetingRecorder.app
          mv MeetingRecorder.zip ../../../../
          cd ../../../../

          # Generate SHA256
          SHA256=$(shasum -a 256 MeetingRecorder.zip | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "SHA256: $SHA256"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: MeetingRecorder.zip
          body: |
            ## Installation

            ```bash
            brew install --cask --no-quarantine zamai/tap/meetingrecorder
            ```

            Or download manually and run:
            ```bash
            xattr -cr /Applications/MeetingRecorder.app
            ```

            ---
            **SHA256:** `${{ env.SHA256 }}`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
